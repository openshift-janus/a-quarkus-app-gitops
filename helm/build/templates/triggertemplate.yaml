---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerTemplate
metadata:
  name: '{{ .Values.app.name }}-run-pipeline'
spec:
  params:
    - name: git-revision
      description: The git revision
      default: '{{ .Values.git.branch }}'
    - name: git-repo-url
      description: The repo url
    - name: output-image
      description: reference of the image that will get created
      default: '{{ include "image.url" . }}'
    - description: Sonarqube host url
      name: sonarqubeHostUrl
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        name: $(uid)
      spec:
        params:
          - name: source-repo
            value: $(tt.params.git-repo-url)
          - name: source-branch
            value: $(tt.params.git-revision)
          - name: output-image
            value: $(tt.params.output-image)
          # - name: SONARQUBE_HOST_URL
          #   value: $(tt.params.sonarqubeHostUrl)
          - name: SONARQUBE_PROJECT_KEY
            value: a-quarkus-app
          - name: SONARQUBE_PROJECT_SECRET
            value: sonarqube-secret
        pipelineRef:
          name: '{{ .Values.app.name }}-pipeline'
        serviceAccountName: pipeline
        timeout: 1h0m0s
        workspaces:
          - name: workspace
            persistentVolumeClaim:
              claimName: a-quarkus-app-build-pvc
          - name: maven-settings
            emptyDir: {}
          - name: m2repo
            persistentVolumeClaim:
              claimName: m2repo-pvc
          # - name: workspace
          #   volumeClaimTemplate:
          #     spec:
          #       accessModes:
          #         - ReadWriteOnce
          #       resources:
          #         requests:
          #           storage: 1Gi
          # - name: maven-settings
          #   volumeClaimTemplate:
          #     spec:
          #       accessModes:
          #         - ReadWriteOnce
          #       resources:
          #         requests:
          #           storage: 2Gi
          #   # emptyDir: {}
          - name: gitcredential
            secret:
              secretName: '{{ .Values.app.name }}-github-pat'
          - name: secrets
            secret:
              secretName: gpg-public-key
